// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["csl"]
}

model User {
  id                  String   @id @default(cuid())
  email               String   @unique
  password            String
  firstName           String
  lastName            String
  companyId           String
  dailyEmailReminders Boolean  @default(true)
  marketingEmails     Boolean  @default(false)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  company       Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  subscriptions Subscription[]

  @@index([email])
  @@index([companyId])
  @@schema("csl")
}

model Company {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users        User[]
  dealers      Dealer[]
  tradeShows   TradeShow[]
  todos        Todo[]
  groups       Group[]
  buyingGroups BuyingGroup[]
  products     Product[]

  @@schema("csl")
}

model Subscription {
  id                   String    @id @default(cuid())
  userId               String
  stripeCustomerId     String    @unique
  stripeSubscriptionId String    @unique
  stripePriceId        String
  status               String // active, canceled, past_due, etc.
  currentPeriodEnd     DateTime
  cancelAtPeriodEnd    Boolean   @default(false)
  canceledAt           DateTime?
  expiryEmailSentAt    DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
  @@index([status])
  @@schema("csl")
}

model Dealer {
  id           String   @id @default(cuid())
  companyId    String
  companyName  String
  contactName  String?
  email        String?
  phone        String?
  city         String?
  state        String?
  zip          String?
  country      String?
  address      String?
  buyingGroup  String?
  status       String   @default("Prospect") // Prospect, Active, Inactive, etc.
  rating       Int? // 1-5 star rating
  notes        String?
  customFields Json? // Store custom CSV fields as JSON
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  company            Company                    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  dealerNotes              DealerNote[]
  photos                   Photo[]
  voiceRecordings          VoiceRecording[]
  todos                    Todo[]
  tradeShows               DealerTradeShow[]
  quickActions             QuickAction[]
  groups                   DealerGroup[]
  buyingGroupHistory       DealerBuyingGroupHistory[]
  products                 DealerProduct[]
  privacyPermissions       PrivacyPermission[]
  privacyPermissionHistory PrivacyPermissionHistory[]
  changeHistory            DealerChangeHistory[]

  @@index([companyId])
  @@index([companyName])
  @@index([email])
  @@index([status])
  @@index([buyingGroup])
  @@schema("csl")
}

model DealerNote {
  id        String   @id @default(cuid())
  dealerId  String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  dealer Dealer @relation(fields: [dealerId], references: [id], onDelete: Cascade)

  @@index([dealerId])
  @@schema("csl")
}

model Photo {
  id           String   @id @default(cuid())
  dealerId     String
  filename     String
  originalName String
  mimeType     String
  size         Int
  path         String
  type         String   @default("business_card") // business_card, badge, other
  createdAt    DateTime @default(now())

  dealer Dealer @relation(fields: [dealerId], references: [id], onDelete: Cascade)

  @@index([dealerId])
  @@schema("csl")
}

model VoiceRecording {
  id            String    @id @default(cuid())
  dealerId      String
  filename      String
  originalName  String
  mimeType      String
  size          Int
  path          String
  duration      Int?      // in seconds
  date          DateTime? // Date associated with the recording
  tradeshowName String?   // Name of the tradeshow
  createdAt     DateTime  @default(now())

  dealer Dealer @relation(fields: [dealerId], references: [id], onDelete: Cascade)

  @@index([dealerId])
  @@index([date])
  @@schema("csl")
}

model TradeShow {
  id          String    @id @default(cuid())
  companyId   String
  name        String
  location    String?
  startDate   DateTime?
  endDate     DateTime?
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  company Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  dealers DealerTradeShow[]

  @@index([companyId])
  @@schema("csl")
}

model DealerTradeShow {
  id          String   @id @default(cuid())
  dealerId    String
  tradeShowId String
  createdAt   DateTime @default(now())

  dealer    Dealer    @relation(fields: [dealerId], references: [id], onDelete: Cascade)
  tradeShow TradeShow @relation(fields: [tradeShowId], references: [id], onDelete: Cascade)

  @@unique([dealerId, tradeShowId])
  @@index([dealerId])
  @@index([tradeShowId])
  @@schema("csl")
}

model Todo {
  id            String    @id @default(cuid())
  companyId     String
  dealerId      String?
  title         String
  description   String?
  completed     Boolean   @default(false)
  completedAt   DateTime? // When the todo was marked as completed
  dueDate       DateTime?
  type          String    @default("general") // general, email, snail_mail
  emailSent     Boolean   @default(false)
  emailSentDate DateTime?
  emailContent  String?   // Store sent email content
  followUp      Boolean   @default(false)
  followUpDate  DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  dealer  Dealer? @relation(fields: [dealerId], references: [id], onDelete: SetNull)

  @@index([companyId])
  @@index([dealerId])
  @@index([completed])
  @@index([type])
  @@schema("csl")
}

model QuickAction {
  id         String   @id @default(cuid())
  dealerId   String
  actionType String // email, snail_mail, etc.
  files      String[] // Array of file identifiers
  interests  String[] // Array of interest tags
  status     String   @default("pending")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  dealer Dealer @relation(fields: [dealerId], references: [id], onDelete: Cascade)

  @@index([dealerId])
  @@index([status])
  @@schema("csl")
}

model Group {
  id        String   @id @default(cuid())
  companyId String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  dealers DealerGroup[]

  @@unique([companyId, name])
  @@index([companyId])
  @@index([name])
  @@schema("csl")
}

model DealerGroup {
  id        String   @id @default(cuid())
  dealerId  String
  groupId   String
  createdAt DateTime @default(now())

  dealer Dealer @relation(fields: [dealerId], references: [id], onDelete: Cascade)
  group  Group  @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([dealerId, groupId])
  @@index([dealerId])
  @@index([groupId])
  @@schema("csl")
}

model BuyingGroup {
  id        String    @id @default(cuid())
  companyId String
  name      String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete - when deleted, move associations to history

  company Company                    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  history DealerBuyingGroupHistory[]

  @@unique([companyId, name])
  @@index([companyId])
  @@index([name])
  @@index([deletedAt])
  @@schema("csl")
}

model DealerBuyingGroupHistory {
  id            String    @id @default(cuid())
  dealerId      String
  buyingGroupId String
  startDate     DateTime  @default(now())
  endDate       DateTime? // null means currently active, set when removed
  createdAt     DateTime  @default(now())

  dealer      Dealer      @relation(fields: [dealerId], references: [id], onDelete: Cascade)
  buyingGroup BuyingGroup @relation(fields: [buyingGroupId], references: [id], onDelete: Cascade)

  @@index([dealerId])
  @@index([buyingGroupId])
  @@index([endDate])
  @@schema("csl")
}

model Product {
  id        String   @id @default(cuid())
  companyId String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company        Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  dealerProducts DealerProduct[]

  @@unique([companyId, name])
  @@index([companyId])
  @@index([name])
  @@schema("csl")
}

model DealerProduct {
  id        String   @id @default(cuid())
  dealerId  String
  productId String
  createdAt DateTime @default(now())

  dealer  Dealer  @relation(fields: [dealerId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([dealerId, productId])
  @@index([dealerId])
  @@index([productId])
  @@schema("csl")
}

model PrivacyPermission {
  id          String   @id @default(cuid())
  dealerId    String
  permission  String   // e.g., "marketing_emails", "data_sharing", "phone_contact"
  granted     Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  dealer Dealer @relation(fields: [dealerId], references: [id], onDelete: Cascade)

  @@unique([dealerId, permission])
  @@index([dealerId])
  @@index([permission])
  @@schema("csl")
}

model PrivacyPermissionHistory {
  id          String   @id @default(cuid())
  dealerId    String
  permission  String
  granted     Boolean
  action      String   // "granted", "revoked", "changed", "deleted"
  changedData Json?    // Store the data that was changed/deleted
  createdAt   DateTime @default(now())

  dealer Dealer @relation(fields: [dealerId], references: [id], onDelete: Cascade)

  @@index([dealerId])
  @@index([permission])
  @@index([createdAt])
  @@schema("csl")
}

model DealerChangeHistory {
  id          String   @id @default(cuid())
  dealerId    String
  fieldName   String   // e.g., "companyName", "email", "status", "rating", "notes"
  oldValue    String?  // Previous value (as string)
  newValue    String?  // New value (as string)
  changeType  String   // "created", "updated", "deleted"
  createdAt   DateTime @default(now())

  dealer Dealer @relation(fields: [dealerId], references: [id], onDelete: Cascade)

  @@index([dealerId])
  @@index([fieldName])
  @@index([createdAt])
  @@schema("csl")
}
